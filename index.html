<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebAR Throwing Game (Marker Pattern)</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>

    <script src="./power-meter.js"></script> 
    <script src="./throw-ball.js"></script> 

    <style>
        /* CSSコードは提供されたものをすべてそのまま残します */
        body { margin: 0; overflow: hidden; }
        canvas { touch-action: none; } 

        /* ターゲットロックインジケーター (デバッグのため非表示を維持) */
        #target-indicator {
            position: fixed; top: 30%; left: 50%;
            transform: translateX(-50%);
            color: white; font-size: 24px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px; border-radius: 5px;
            z-index: 9999;
            display: none; 
        }

        /* デバッグ情報表示エリア */
        #debug-info {
            position: fixed; top: 10px; left: 10px;
            color: white; font-size: 14px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px; border-radius: 3px;
            z-index: 9998; font-family: monospace;
            display: none !important; 
        }
        
        /* タッチ/投球デバッグ表示エリア */
        #touch-debug {
            position: fixed; top: 68%; left: 50%;
            transform: translateX(-50%);
            color: yellow; font-size: 20px;
            background-color: rgba(255, 0, 0, 0.7); 
            padding: 5px 15px; border-radius: 5px;
            z-index: 9999;
            display: none;
        }

        /* *** パワーメーターエリア *** */
        #power-meter {
            position: fixed; top: 50%; left: 10px;
            transform: translateY(-50%);
            width: 25px; height: 200px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid white; border-radius: 5px;
            z-index: 9997; overflow: hidden;
            position: fixed; 
        }

        /* パワーバー */
        #power-bar {
            width: 100%; height: 0%;
            background: linear-gradient(to top, #FF0000 0%, #FFA500 40%, #00FF00 60%, #FFA500 80%, #FF0000 100%);
            position: absolute; bottom: 0;
            transition: none; 
        }

        /* 【追加】ターゲットライン */
        #target-line {
            position: absolute; top: 50%; 
            left: 0; width: 100%; height: 2px;
            background-color: white; z-index: 1; 
            transform: translateY(-50%); 
        }

        /* 【追加】パワーメーター指示テキスト */
        #power-instruction {
            position: fixed; top: 50%; left: 45px; 
            transform: translateY(-50%);
            color: white; font-size: 16px; 
            white-space: nowrap; z-index: 9997;
            pointer-events: none; 
        }
        
        /* *** 結果表示エリア (画面中央) *** */
        #score-display-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000; display: none;
            text-align: center;
        }
        #score-display-message {
            color: white; font-size: 32px; 
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px 20px; border-radius: 10px;
            margin-top: 15px; line-height: 1.2;
        }
        
        /* 結果テキストのサイズを調整 */
        #score-display-message small {
            font-size: 20px; display: block; 
            line-height: 1.0;
        }
        
        /* *** 「もう1かい」ボタン *** */
        #reset-button {
            display: block; margin: 0 auto;
            font-size: 24px; font-weight: bold;
            color: #111; background-color: #eee;
            border: 3px solid #111;
            padding: 10px 30px; border-radius: 8px;
            cursor: pointer; margin-bottom: 0; 
        }
        
        /* *** 前回得点表示エリア (画面右上) *** */
        #last-score-display {
            position: fixed; top: 10px; right: 10px;
            color: white; font-size: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px; border-radius: 5px;
            z-index: 9999; font-family: monospace;
        }
        
        /* *** 投球指示テキスト (HTML要素) *** */
        #throw-instruction {
            position: fixed; top: 60%; left: 50%;
            transform: translateX(-50%);
            color: white; font-size: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 5px 15px; border-radius: 5px;
            z-index: 9996; cursor: pointer; 
            text-align: center; line-height: 1.2;
        }
    </style>
</head>

<body>
    <div id="target-indicator" style="display: none;">ロックオン！</div>
    <div id="touch-debug" style="display: none;"></div>
    <div id="last-score-display">前回: -</div>

<div id="throw-instruction">
    マーカーにねらいをさだめて<br>タップ！
</div>

<div id="score-display-container" style="display: none;">
    <button id="reset-button" onclick="resetGame()">もう1かい</button>
    <div id="score-display-message"></div>
</div>

<script>
    // グローバル関数: ゲームリセット (この関数は維持)
    function resetGame() {
        const throwBallEl = document.getElementById('throwButton');
        // ... (省略) ...
    }
    
    // ❌ 修正点: handleTouchStart() グローバル関数を削除
</script>


    <a-scene 
        embedded 
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        raycaster="objects: [throw-ball];"
        power-meter>
        
        <a-marker type='pattern' url='./shatekimato.patt'>
            <a-circle 
                id="throwButton" 
                color="#00FFFF" 
                radius="0.15" 
                position="0 0 0" 
                rotation="-90 0 0" 
                opacity="0.5"
                throw-ball>
            </a-circle>
        </a-marker>
        
        <a-entity camera cursor="rayOrigin: mouse">
            <a-ring 
                color="#FFFFFF" 
                radius-inner="0.02" 
                radius-outer="0.03" 
                position="0 0 -1" 
                opacity="0.8">
            </a-ring>
        </a-entity>
        
        <a-light type="directional" position="1 2 1" intensity="0.8" castShadow=""></a-light>
        <a-light type="ambient" intensity="0.4"></a-light>

    </a-scene>
</body>
</html>